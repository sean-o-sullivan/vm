import re
import unicodedata
from bs4 import BeautifulSoup
from collections import Counter

def find_true_end(text, initial_end_pos, lookahead_range=1000):
    current_end_pos = initial_end_pos
    while True:
        lookahead_text = text[current_end_pos:current_end_pos + lookahead_range]
        next_end_match = re.search(r'([=]{5,}|[-]{5,}|[.]{5,}|-{10,})', lookahead_text)
        if next_end_match:
            current_end_pos += next_end_match.end()
        else:
            break
    return current_end_pos

def remove_table_from_text(text, stats):
    cleaned_text = ""
    position = 0
    removed_tables = []
    while True:
        start_match = re.search(r'\b[A-Z]{5,}\b', text[position:])
        if not start_match:
            cleaned_text += text[position:]
            break
        start_pos = position + start_match.start()
        cleaned_text += text[position:start_pos].strip() + "\n"
        lookahead_range = 500
        lookahead_text = text[start_pos:start_pos + lookahead_range]
        table_end_match = re.search(r'([=]{5,}|[-]{5,}|[.]{5,}|-{10,})', lookahead_text)
        if not table_end_match:
            position = start_pos + len(start_match.group(0))
            continue
        initial_end_pos = start_pos + table_end_match.end()
        true_end_pos = find_true_end(text, initial_end_pos)
        table_content = text[start_pos:true_end_pos]
        removed_tables.append(table_content)
        stats['tables_removed'] += 1
        position = true_end_pos
    return cleaned_text.strip(), removed_tables

def clean_text(text, use_table=False):
    stats = Counter()
    removed_tables = []
    soup = BeautifulSoup(text, 'html.parser')
    stats['html_tags_removed'] = len(list(soup.find_all()))
    text = soup.get_text()
    text, n = re.subn(r'\((?:\w+,?\s+(?:et al\.)?,?\s+)?(?:19|20)\d{2}[a-z]?(?::\d+(?:-\d+)?)?(?:\s+and\s+(?:\w+,?\s+(?:et al\.)?,?\s+)?(?:19|20)\d{2}[a-z]?(?::\d+(?:-\d+)?)?)*\)', '', text)
    stats['citations_removed'] += n
    text, n = re.subn(r'\[.*?\]', '', text)
    stats['square_brackets_removed'] += n

    if use_table:
        text, tables = remove_table_from_text(text, stats)
        removed_tables.extend(tables)

    text, n = re.subn(r'\{.*?\}', '', text)
    stats['curly_braces_removed'] += n
    patterns = {
        r'\*+': 'asterisks_removed',
        r'(?m)^\s*[\|+].*[\|+]\s*$': 'table_like_structures_removed',
        r'(?m)^\s*[-+]+\s*$': 'table_like_structures_removed',
        r'(?m)^\s*[a-zA-Z0-9]+\s*[-+*/^()]+.*$': 'equations_removed',
        r'[±∓×÷∙∘·°∂∇∆∑∏∫√∛∜∝∞≈≠≡≤≥≪≫⊂⊃⊄⊅⊆⊇⊈⊉⊊⊋∈∉∋∌∍∎∏∐∑−]': 'special_characters_removed'
    }

    for pattern, stat_key in patterns.items():
        text, n = re.subn(pattern, '', text)
        stats[stat_key] += n

    text = unicodedata.normalize('NFKD', text).encode('ASCII', 'ignore').decode('ASCII')
    words_to_remove = ["Introduction", "Summary", "Abstract", "Objective", "Executive Summary"]
    for word in words_to_remove:
        text, n = re.subn(r'\b' + re.escape(word) + r'\b', '', text)
        stats[f'{word}_removed'] = n

    text, n = re.subn(r'([!?.]){2,}', r'\1', text)
    stats['repeated_punctuation_removed'] += n
    text, n = re.subn(r'\s+([,.!?:;])', r'\1', text)
    text, n = re.subn(r'([,.!?:;])\s+', r'\1 ', text)
    text = re.sub(r'\s+', ' ', text).strip()

    return text, stats, removed_tables
sample_text_1 = """Al-Zahrāwī, being associated with war casualties and writing his treatise about the end of the 10th century, no doubt had the experience of dealing with cases involving injuries caused by arrows. The text in chapter 94 discloses his observations in elaborate investigations regarding the extraction of various kinds of arrows from the body.[28] Accordingly, several kinds of hooks and forceps for removing arrows are described and depicted in the treatise (see fig. 18). Al-Zahrāwī’s mention of Turkish bows and arrows led Freind to believe, erroneously, that the author of the treatise must have lived in the 12th century,[29] notwithstanding the fact that Turkish bows and arrows were in common use in the latter part of the 10th century. [Illustration: Figure 17.--A crude form of bulb syringe recommended for use with children. Top, from original Arabic manuscript (Ali 2854), courtesy Süleymaniye Umumi Kütüphanesi Müdürlüğü. Bottom, from Leclerc, Abulcasis.] The next chapter, on cupping, mentions the use of cups made of horns, wood, copper, or glass, according to circumstances and the availability of material. The methods of treatment are divided into two kinds: dry cupping, with or without fire, and wet cupping (see fig. 19). He prescribes ointments and aromatic and medicated waters to be applied before and after cupping to facilitate healing. Only when cupping is not possible, as on the nose, fingers, and similar parts of the human body, does he propose the use of leeches for treatment.[30] Evidently this is an indication that he did not, as generally supposed, encourage the widespread use of leeches. [Illustration: Figure 18.--Hooks and forceps used for the extraction of arrows. Top, from original Arabic manuscript (Tüb. MS. 91), courtesy Universitätsbibliothek Tübingen. Bottom, from Channing, Albucasis.] [Illustration: Figure 19.--Cupping. Top, from original Arabic manuscript (Tüb. MS. 91), courtesy Universitätsbibliothek Tübingen. Bottom, from Argellata 1531, courtesy National Library of Medicine.] The third and final section, of 35 chapters, deals with the reduction, luxation, and treatment of injured bones, including fracture of the pelvis. The advices and warnings in the prelude of this section appear to repeat some of al-Zahrāwī’s sayings that had been covered in his previous introductions. The text, however, presents many facets of interest to the health professions. It elaborates upon the application of various forms of bandages and plasters in a variety of operations. Al-Zahrāwī’s detailed description relating to fractures of bones is a fine anatomical document of historical interest. He illustrates and describes special methods for tying injured or broken bones, and he suggests that bandages made of soft linen be less and less tight as distance increases from the injured place (chapter 1). For the protection of areas adjacent to the injured part against contact with edges of splints he advocates padding with soft gauze and carded wool. In some cases, to guard against swelling, he preferred a delay of one or more days in applying bandages over splints. Al-Zahrāwī also devised and depicted many kinds and shapes of splints for use in simple and compound fractures of the head, shoulders, arms, fingers, etc. (see fig. 20). For example, in discussing the reduction of the humerus, he recommends a splint consisting of a smooth, thin stick bent in the shape of a bow with two strings, each attached to one end of the stick (fig. 21). The injured bone is then placed in the middle of the bent splint for reduction while the patient is seated on a chair. Tying is applied only when there is no ""hot"" swelling (chapter 11). One of the remarkable observations made in this section is the description of the paralysis caused by fracture of the spine. [Illustration: Figure 20.--Splint ""in the shape of a spoon without a bowl."" Top, from original Arabic manuscript (Tüb. MS. 91), courtesy Universitätsbibliothek Tübingen. Bottom, from Channing, Albucasis.] Of interest to historians of medical therapy and pharmacy are the recipes for poultices that al-Zahrāwī recommends for use over fractured bones. For example, he gives the following recipe for one such poultice: ""Take the so-called 'mill’s dust' [ghubār al-rahā], which is the part of the wheat flour that clings to the walls of the mill during grinding [lubāb al-daqīq], and, without sifting away the bran, knead with white-of-egg to a medium consistency, and apply."" Another, more elaborate, recipe calls for 10 dirhams each of the roots of wild pomegranate [Glossostemon bruguieri D.C.], chickling vetch [the grass pea, Lathymus sativus], and white marshmallow; 5 dirhams each of myrrh and aloes; 6 dirhams of white gum Arabic [Acacia]; and 20 dirhams of bole [friable earthy clay consisting largely of hydrous silicates of aluminum and magnesium, usually colored red because of impurities of iron oxide]. Procedure was to pound all ingredients gently, pass them through a sieve, and knead with water or white-of-egg (chapter 1). [Illustration: Figure 21.--A splint to support the arm. Top, from original Arabic manuscript (Cod. N.F. 476A), courtesy Oesterreichische Nationalbibliothek. Bottom, from Argellata 1531, courtesy National Library of Medicine.] The question arises as to whether al-Zahrāwī did any human dissection. The answer is uncertain because our knowledge of his life is fragmentary. However, he gives no clue to the dissection of humans in any of the 30 treatises of al-Taṣrīf--his only known writings--and there is no evidence that he practiced it in secret. His upright attitude as a Muslim who repeatedly emphasized his adherence to his faith suggests that he relied completely on animal dissection and the writings of his Greek-Roman and Islamic predecessors. Physicians in both the Islamic domain and in Christendom for many centuries were hostile to the idea of human dissection for any purpose because of their traditional socio-religious convictions, considering it an unethical and undignified practice. Perhaps it has been al-Zahrāwī’s original contributions to surgery, his enthusiasm in emphasizing the value of anatomical knowledge, and his recognition of the necessity that only well-educated, well-trained doctors should perform surgery that have led some medical historians to wonder whether he did human dissection at some time in his long years of experience. In Summary The few examples of illustrations of surgical instruments given here indicate that the Arabic manuscripts, in general, have preserved the original, oriental, artistic features of the drawings in a way that has been overlooked in Latin and vernacular versions of al-Taṣrīf. In presenting his personal observations and original ideas on surgery late in life, al-Zahrāwī, for the most part, was inspired by a thorough acquaintance with Greek and Arabic medical literature supplemented by lifelong intelligent observation and experience. Through its descriptions and illustrations, the surgical treatise of al-Zahrāwī very likely played a significant role in the designing of improved surgical instruments in the Middle Ages. Also, the treatise no doubt promoted the development of improved surgical techniques in Islam and, through its translations, promoted these techniques to an even greater extent in the West, a fact that justifies the fame of this treatise as the highest expression of the development of surgery in Arabic Spain--a treatise whose influence continued to the Renaissance. It contributed in no small measure to the idea of equipping learned and well-trained surgeons with the best surgical tools and techniques of the time; moreover, it encouraged the invention of new instruments to meet differing circumstances and special conditions. These tools no doubt greatly facilitated the work of the surgeon. Throughout the text of al-Taṣrīf al-Zahrāwī gave careful attention to the importance of pharmaceutical preparations in the healing art, including cases requiring surgery. [1] George Sarton, Introduction to the History of Science, Baltimore, 1927, vol. 1, p. 681. [2] Mohammad S. Abu Ganima, in Abul-Kasim ein Forscher der Arabischen Medizin, Berlin, 1929, suggested that description of operations in al-Majūsī’s surgery is clearer than that in al-Zahrāwī’s--a statement which does not seem acceptable. [3] Max Neuburger, Geschichte der Medizin, Stuttgart, 1911, vol. 2, pt. 1, pp. 178-179. [4] Heinrich Haeser, Lehrbuch der Geschichte der Medizin und der epidemischen Krankh"""
sample_text_2 = """
Cobalt-60 has been used for several years, but recently cobalt-58 has been found more satisfactory. It has a half-life of 72 days while ⁶⁰Co has a 5.3-year half-life. This reduces greatly the amount of radiation to the patient’s liver by the retained radioactivity. Iodine-131 Like chromium-51, iodine is a versatile tracer element. It is used to determine blood volume, cardiac output, plasma volume, liver activity, fat metabolism, thyroid cancer metastases, brain tumors, and the size, shape, and activity of the thyroid gland. [Illustration: A linear photoscanner produced these pictures of (A) a normal thyroid, (B) an enlarged thyroid, and (C) a cancerous thyroid.] Because of its unique connection with the thyroid gland, iodine-131 is most valuable in measurements connected with that organ. Thyroxin, an iodine compound, is manufactured in the thyroid gland, and transferred by the blood stream to the body tissues. The thyroxin helps to govern the oxygen consumption of the body and therefore helps control its metabolism. Proper production of thyroxin is essential to the proper utilization of nutrients. Lowered metabolism means increased body weight. Lowered thyroid activity may mean expansion of the gland, causing one form of goiter. Iodine-131 behaves in the body just as the natural non-radioactive isotope, iodine-127, does, but the radioactivity permits observation from outside the body with some form of radiation counter. Iodine can exist in the body in many different chemical compounds, and the counter can tell where it is but not in what form. Hence chemical manipulation is necessary in applying this technique to different diagnostic procedures. The thyroid gland, which is located at the base of the neck, is very efficient in trapping inorganic iodide from the blood stream, concentrating and storing the iodine-containing material and gradually releasing it to the blood stream in the form of protein-bound iodine (PBI). One of the common diagnostic procedures for determining thyroid function, therefore, is to measure the percentage of an administered dose of ¹³¹I that is taken up by the gland. Usually the patient is given a very small dose of radioactive sodium iodide solution to drink, and two hours later the amount of iodine in the gland is determined by measuring the radiation coming from the neck area. In hyperthyroidism, or high thyroid gland activity, the gland removes iodide ions from the blood stream more rapidly than normal. [Illustration: Screening test for Hyperthyroidism Oral dose ¹³¹I Graph of Uptake in 1 hour (Percent of administered dose) versus Uptake in 24 hours (Percent of administered dose)] [Illustration: It is especially important in isotope studies on infants and small children that the radiation exposure be low. By carrying out studies in the whole body counter room, the administered dose can be greatly reduced. The photographs illustrate a technique of measuring radioiodine uptake in the thyroid gland with extremely small amounts of a mixture of iodine-131 and iodine-125. A shows a small television set that is mounted above the crystal in such a way that good viewing requires that the head be kept in the desired position. This helps solve the problem of keeping small children still during a 15-minute counting period. B shows a child in position for a thyroid uptake study.] This simple procedure has been used widely. One difficulty in using it is that its success is dependent upon the time interval between injection and measurement. An overactive gland both concentrates iodine rapidly and also discharges it back to the blood stream as PBI more rapidly than normal. Modifications of the test have been made to compare the amount of iodine-131 that was administered with the amount circulating in the blood as PBI. The system acquires chemical separation of the two forms of iodine from a sample of blood removed from a vein, followed by separate counting. This computation of the conversion ratio of radioactive plasma PBI to plasma-total ¹³¹I gives results that are less subject to misinterpretation. To determine local activity in small portions of the thyroid, an automatic scanner is used. A collimator[9] shields the detector (a Geiger-Müller tube or scintillating crystal) so that only those impulses originating within a very small area are accepted by the instrument. The detector is then moved back and forth slowly over the entire area and the radiation is automatically recorded at definite intervals, creating a map of the active area. In cases where lumps, or nodules, have been discovered in the thyroid, the map is quite helpful in distinguishing between cancerous and benign nodules. The former are almost always less radioactive than surrounding tissues. [Illustration: Seven serial scans made with the whole body scanner were put together to provide a whole body scan of this patient with thyroid cancer that had spread to the lung. One millicurie of iodine-131 was administered and the scan made 72 hours later. Note the uptake in the lung. This patient was successfully treated with large doses of iodine-131.] Fragments of cancerous thyroid tissue may migrate to other parts of the body and grow there. These new cancers are known as metastatic cancers and are a signal of an advanced state of disease. In such a situation even complete surgical removal of the original cancer may not save the patient. If these metastases are capable of concentrating iodine (less than 10% of them are), they can be located by scanning the whole body in the manner that was just described. When a thyroid cancer is discovered, therefore, a doctor may look for metastases before deciding to operate. Human blood serum albumin labeled with ¹³¹I is used for measurement of the volume of circulating plasma. The procedure is quite similar to that used with radioactive chromium. Iodinated human serum albumin labeled with ¹³¹I is injected into a vein. Then, after allowing time for complete mixing of the sample with the blood, a second sample is counted using a scintillation counter. [Illustration: Time-lapse motion pictures of the liver of a 3-year-old girl were made with the scintillation camera 1 hour after injection of 50 microcuries of iodine-131-labeled rose bengal dye. This child was born without a bile-duct system and an artificial bile duct had been created surgically. She developed symptoms that caused concern that the duct had closed. These scans show the mass of material containing the radioactive material (small light area) moving downward and to the right, indicating that the duct was still open.] For many years, a dye known as rose bengal has been used in testing liver function. About 10 years ago this procedure was improved by labeling the dye with ¹³¹I. When this dye is injected into a vein it goes to the liver, which removes it from the blood stream and transfers it to the intestines to be excreted. The rate of disappearance of the dye from the blood stream is therefore a measure of the liver activity. Immediately after administration of the radioactive dye, counts are recorded, preferably continuously from several sites with shielded, collimated detectors. One counter is placed over the side of the head or the thigh to record the clearance of the dye from the blood stream. A second is placed over the liver, and a third over the abdomen to record the passage of the dye into the small intestine. Human serum albumin labeled with ¹³¹I is sometimes used for location of brain tumors. It appears that tumors alter a normal barrier between the brain and blood in such a manner that the labeled albumin can penetrate tumorous tissues although it would be excluded from healthy brain tissue. [Illustration: Showing:] 1 Human serum albumin labeled with ¹³¹I 2 Tumor selectively localizes labeled albumin 3 Survey of gamma radiation (Standard points) The brain behaves almost uniquely among body tissues in that a blood-brain barrier exists, so that substances injected into the blood stream will not pass into brain cells although they will pass readily into muscular tissue. This blood-brain barrier does not exist in brain tumors. A systematic scanning of the skull then permits location of these cancerous hot spots . Iron-59 Iron is a necessary constituent of red blood cells, so its radioactive form, ⁵⁹Fe, has been used frequently in measurement of the rate of formation of red cells, the lifetime of red cells, and red cell volumes. The labeling is more difficult than labeling with chromium for the same purposes, so this procedure no longer has the importance it once had. On the other hand, direct measurement of absorption of iron by the digestive tract can be accomplished only by using ⁵⁹Fe. In achlorhydria the gastric juice in the stomach is deficient in hydrochloric acid, and this condition has been shown to lower the iron absorption. A normal diet contains much more iron than the body needs, but in special cases, sometimes called tired blood in advertising for medicines, iron compounds are prescribed for the patient. If ⁵⁹Fe is included, its appearance in the blood stream can be monitored and the effectiveness of the medication noted. [Illustration: This multiple-port scintillation counter is used for iron-kinetic studies. The tracer dose of iron-59 is administered into the arm vein and then the activities in the bone marrow, liver, and spleen are recorded simultaneously with counters positioned over these areas, and show distribution of iron-59 as a function of time. When the data are analyzed in conjunction with iron-59 content in blood, information can be obtained about sites of red blood cell production and destruction.] Phosphorus-32 The phosphate ion is a normal constituent of the blood.

"""
cleaned_text_1, stats_1, removed_tables_1 = clean_text(sample_text_2, use_table=False)
print(f"Cleaned Text 1:\n{cleaned_text_1}\n")
print(f"Stats 1:\n{stats_1}\n")
if removed_tables_1:
    print(f"Removed Tables 1:\n{removed_tables_1}\n")
